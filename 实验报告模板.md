## 《云计算技术》期末实验大作业报告

### 0. 基本信息

- **课程名称**：云计算技术
- **学期/班级**：2025年秋/23大数据2班
- **小组编号/组名**：
- **选题编号与题目**：A6 / 镜像构建
- **成员信息**：
  - 组长：潘丽娜-2361170060-项目设计 
  - 成员1：李梦君-2361170059-实验报告
  - 成员2：王露-2361150055-答辩
  - 成员3：潘婉钰-236-答辩PPT+仓库提交
- **完成日期**：2026-01-04
- **代码仓库地址**：`https://...`（如适用）

---

### 1. 摘要

  本项目基于Ubuntu系统，使用Docker技术完成容器化应用部署。通过编写多阶段Dockerfile实现镜像瘦身，体积从1.11GB减少到65.5MB，优化率达94.1%。实现了端口映射、环境变量配置、卷挂载等功能，并通过脚本自动化验证了所有功能。项目体现了云计算的可复现、可验证、可解释原则。

---

### 2. 需求与目标

- **背景与问题描述**：学习Docker容器化技术，掌握镜像构建和容器管理
- **功能目标**：
  - 目标1：编写Dockerfile构建镜像
  - 目标2：演示端口映射、环境变量、卷挂载
  - 目标3：实现版本标签管理
  - 目标4：镜像瘦身优化
- **性能/可靠性/安全目标**：镜像体积减少50%以上
- **不做的范围（明确边界）**：不涉及Kubernetes编排和云平台部署

---

### 3. 相关概念与原理


- 概念1：容器化技术
  - 解释：将应用及其依赖打包成独立单元，实现环境一致性
  - 在本项目中的体现：使用Docker容器封装Flask应用
    
- 概念2：多阶段构建
  - 解释：使用多个FROM指令，前一阶段构建，后一阶段运行
  - 在本项目中的体现：Dockerfile分builder和runtime阶段
    
- 概念3：镜像瘦身
  - 解释：通过Alpine基础镜像、删除缓存等方式减小镜像体积
  - 在本项目中的体现：从1.11GB优化到65.5MB

---

### 4. 实验环境与资源清单

#### 4.1 硬件与网络

- 机器数量：1台
- CPU/内存/磁盘：4/8GB/256GB
- 网络环境（校园网/宿舍/实验室/是否需要 NAT）：校园网+NAT网络

#### 4.2 软件与版本

- 宿主机 OS：Windows 11
- 虚拟化软件：VMware 17pro
- 虚拟机OS：Ubuntu 24.04.3 LTS
- Docker 版本：28.5.1
- 其他依赖：
    - Flask版本： 2.3.3
    - gunicorn版本： 20.1.0
    - requests版本： 2.31.0
    - python-dotenv版本： 1.0.0
    - FROM python:3.9-slim  # 基础镜像：包含Python 3.9 + Debian （Docker相关依赖）
    - FROM python:3.9-alpine # 最终镜像：Python 3.9 + Alpine Linux （Docker相关依赖）

---

### 5. 总体方案设计

#### 5.1 架构图/拓扑图

<img width="1215" height="1172" alt="a07dded2846fcfc6eb2bedc2ba6072bb" src="https://github.com/user-attachments/assets/58d1599a-30da-4dc0-bed2-524710caf35c" />
<img width="1284" height="474" alt="71833c0af72fee3830e79519a52173c5" src="https://github.com/user-attachments/assets/e1be5015-e903-4911-bce6-16cae25ae373" />

---

### 6. 实现过程

#### 6.1 准备工作

- 关键前置条件检查：系统环境检查、Docker安装状态检查、网络连接检查
- 初始化命令/脚本（如有）：
- 步骤1：系统环境初始化
  - 创建项目目录结构
  -      mkdir -p ~/cloud-final-project/{src/app,assets,report,slides,data,logs,config}
  -      cd ~/cloud-final-project
  -      vim setup-env.sh
  -  运行环境准备脚本
  -       chmod +x setup-env.sh && ./setup-env.sh
  - 目录标准化：创建清晰的目录结构（src/app存放源码，data存放数据，report存放文档）便于项目管理；环境隔离：为Docker项目创建独立的项目空间，避免与其他项目冲突；权限准备：脚本会自动配置Docker用户组权限，解决后续"permission denied"问题。
  
- 步骤2：Docker环境验证
  - 验证Docker安装
  -         docker --version
  - 测试Docker运行
  -         docker run --rm hello-world
  - 创建项目专用网络
  -         docker network create cloud-final-net
  - 环境确认：确保Docker正确安装且能正常运行，避免后续构建失败；资源隔离：创建专用网络为后续多容器通信做准备；故障预防：提前发现环境问题，减少调试时间。
       
#### 6.2 核心步骤与命令清单

**阶段一：应用代码编写**
- 步骤 1：创建Flask应用
  - 命令：
  -     cd ~/cloud-final-project/src/app
  -     vim app.py
  - 参数解释：
  - host='0.0.0.0'：监听所有网络接口
  - port=5000：Flask默认端口
  - debug=False：生产环境关闭调试模式
  - 输出/结果（截图/日志）：
  - <img width="864" height="518" alt="image" src="https://github.com/user-attachments/assets/c2d72eea-17ae-4a1c-b0a9-3ed6e205d766" />
  - 作用：提供一个演示用的Web应用，展示容器化功能。

- 步骤 2：创建依赖文件
  - 命令：
  -     cd ~/cloud-final-project/src  
  - 参数解释：
  - Flask==2.3.3：固定Flask版本，确保环境一致性
  - gunicorn==20.1.0：生产环境WSGI服务器
  - python-dotenv==1.0.0：环境变量管理
  - 输出/结果（截图/日志）：
    <img width="864" height="171" alt="image" src="https://github.com/user-attachments/assets/1c9179be-60a9-415c-96e9-4ed11c5a4b3b" />

**阶段二：Docker镜像构建**
- 步骤 3：创建Dockerfile（未优化版本）
  - 命令：
  -     cd ~/cloud-final-project/src
  -     vim Dockerfile.base
  - 参数解释：
  - WORKDIR /app：设置工作目录
  - COPY . .：复制所有文件到容器
  - EXPOSE 5000：声明容器监听端口
  - CMD：容器启动命令
  - 输出/结果（截图/日志）：
  - <img width="865" height="217" alt="image" src="https://github.com/user-attachments/assets/987de563-e3e9-4940-8056-f3b5f374e027" />
  - 作用：作为对比，展示未优化的Dockerfile。
  
- 步骤 4：创建多阶段Dockerfile（优化版本）
  - 命令：
  -     cd ~/cloud-final-project/src
  -     vim Dockerfile
  - 参数解释：
  - FROM python:3.11-alpine：使用Alpine Linux，镜像仅~5MB
  - --from=builder：多阶段构建，只复制运行所需文件
  - --user：安装到用户目录，避免全局安装
  - addgroup/adduser：创建非root用户增强安全性
  - HEALTHCHECK：配置容器健康检查
  - 输出/结果（截图/日志）：
  - <img width="865" height="559" alt="image" src="https://github.com/user-attachments/assets/c058ff2b-b75b-48a5-a4a1-cdbf4edf39af" />
  - 作用：定义如何将应用打包成Docker镜像，采用优化策略。
  
- 步骤 5：构建镜像并对比
  - 命令：
  -     cd ~/cloud-final-project/src
  -     vim build.sh
  -     chmod +x build.sh
  -     ./build.sh
  - 输出/结果（截图/日志）：
  - <img width="864" height="364" alt="image" src="https://github.com/user-attachments/assets/72b35752-a32f-40c4-a637-6eb99dd045ea" />
    <img width="864" height="264" alt="image" src="https://github.com/user-attachments/assets/11c46763-44d9-4fb2-b193-7950a3841e6a" />
    <img width="864" height="149" alt="image" src="https://github.com/user-attachments/assets/2bd10e01-899d-468e-96bb-5b7ae2344122" />
    <img width="865" height="224" alt="image" src="https://github.com/user-attachments/assets/6013bdba-c046-4c53-887d-3b0083aa2878" />
    <img width="864" height="414" alt="image" src="https://github.com/user-attachments/assets/b5d09d97-e419-4103-be65-19accafc3d9a" />
    <img width="865" height="195" alt="image" src="https://github.com/user-attachments/assets/74baf473-dd39-4d60-98ef-3ce82255a99b" />
    - 作用：自动化构建镜像，并提供详细反馈。
    
**阶段三：容器运行与管理**
- 步骤 6：运行多个容器实例
  - 命令：
  -     cd ~/cloud-final-project/src
  -     vim run.sh
  -     chmod +x run.sh
  -     ./run.sh
  - 参数解释：
  - -p 8081:5000: 端口映射，主机8081映射到容器5000
  - -e FLASK_ENV=development: 设置环境变量
  - -v $(pwd)/../data/logs:/app/logs: 卷挂载，持久化日志
  - --name cloud-final-demo1: 指定容器名称
  - 输出/结果（截图/日志）：
  - <img width="865" height="458" alt="image" src="https://github.com/user-attachments/assets/60208ad4-1b98-46fe-894a-05b226a6a532" />
    <img width="864" height="399" alt="image" src="https://github.com/user-attachments/assets/687788e2-7375-43af-808a-2f01dbbf1c38" />
    <img width="864" height="218" alt="image" src="https://github.com/user-attachments/assets/530532de-0070-4095-82d4-48cbe9802500" />
  - 作用：演示Docker容器的不同运行方式。

- 步骤 7：验证容器状态
  - 命令：
  -     docker ps
  - 参数解释：
  - docker ps：显示运行中的容器
  - 输出/结果（截图/日志）：
    <img width="937" height="319" alt="8d81f59a204d417c6d9acd9befcf3dec" src="https://github.com/user-attachments/assets/7d66c4a7-c250-4da4-8061-b715844890f6" />

**阶段四：功能验证测试**
- 步骤 8：功能验证
  - 命令：
  -     cd ~/cloud-final-project/src
  -     vim test.sh
  -     chmod +x test.sh
  -     ./test.sh
  - 参数解释：
  - curl -s http://localhost:9999/health: 静默模式访问健康检查
  - docker run -d --name test-container: 启动测试容器
  - docker stop test-container: 停止测试容器
  - docker rm test-container: 删除测试容器
  - 输出/结果（截图/日志）：
    <img width="865" height="505" alt="image" src="https://github.com/user-attachments/assets/22261fc4-3346-4f6a-b57b-64c7b6e2092e" />
    <img width="865" height="401" alt="image" src="https://github.com/user-attachments/assets/837ba2ba-d278-4872-aa4d-338460cbc2ff" />
  - 作用：自动化验证所有功能是否正常工作。

#### 6.3 关键配置文件
**Dockerfile优化措施：**
- 使用Alpine基础镜像：从python:3.9（~300MB）换成python:3.9-alpine（~40MB）
- 多阶段构建：构建阶段使用slim镜像安装编译工具，运行阶段只复制必要的文件
- 清理缓存：安装后立即删除apt缓存和pip缓存
- 合并RUN指令：减少镜像层数，从15层优化到8层
---

### 7. 功能验证与结果展示
- **验证用例列表**（输入/操作 -> 预期 -> 实际结果）：
  - 用例1：环境准备验证
    - 输入/操作：运行./setup-env.sh
    - 预期结果：显示Docker版本信息，显示完整项目结构，显示6个环境变量
    - 实际结果：
      <img width="864" height="338" alt="image" src="https://github.com/user-attachments/assets/cdae8657-5de9-4bc9-b48f-f6feee34675b" />
      <img width="864" height="406" alt="image" src="https://github.com/user-attachments/assets/d5679960-ef5f-4cf9-9b8c-4100847a6fef" />
      <img width="865" height="360" alt="image" src="https://github.com/user-attachments/assets/ad6a85b2-60f0-459e-b3f8-36b1026e81f4" />
    - 分析：输出中的"✓"标志和成功信息说明环境准备成功

  - 用例2：API功能验证
    - 1.输入操作：curl http://localhost:8081/
    - 预期结果：JSON格式的项目信息
    - 实际结果：
      <img width="864" height="56" alt="image" src="https://github.com/user-attachments/assets/a4c2f9c9-4a17-43ce-ac78-0c77feefe912" />
    - 2.输入操作：curl http://localhost:8082/env
    - 预期结果：显示FLASK_ENV等变量
    - 实际结果：
      <img width="1233" height="72" alt="538a2952-80d7-4b33-a814-37651b8e1834" src="https://github.com/user-attachments/assets/58769a7e-6aed-4587-9e20-ee51f792b573" />
    - 3.输入操作：curl http://localhost:8083/info
    - 预期结果：显示容器内部信息
    - 实际结果：
      <img width="861" height="56" alt="image" src="https://github.com/user-attachments/assets/71368782-1510-4b88-ad32-b54e59e8f3ea" />
    - 4.输入操作：curl http://localhost:8081/healthy
    - 预期结果：{"status": "healthy"}
    - 实际结果：
      <img width="594" height="39" alt="image" src="https://github.com/user-attachments/assets/f821360c-fbc9-4d9b-aaf0-59ca16a7e629" />
    - 分析：返回JSON格式的健康状态，status字段为"healthy"，说明应用正常运行
      
  - 用例3：镜像构建验证
    - 输入/操作：运行./build.sh
    - 预期结果：成功构建三个镜像标签，显示大小对比
    - 实际结果：
      <img width="864" height="414" alt="image" src="https://github.com/user-attachments/assets/e08ec455-a918-4caf-ba25-1280e9e52905" />
    - 分析：镜像体积从1.11GB减少到65.5MB，优化率94.1%，证明多阶段构建有效
      
   - 用例4：容器运行验证
     - 输入/操作：运行./run.sh后执行docker ps
     - 预期结果：三个容器正常运行，端口映射正确
     - 实际结果：
       <img width="875" height="313" alt="image" src="https://github.com/user-attachments/assets/38f4b773-7d09-4610-8c89-141b4be1eb1e" />
     - 分析："Up"状态和端口映射信息说明容器正常运行
       
- **关键截图/输出**：
  - 截图1：镜像大小对比结果
   <img width="568" height="151" alt="image" src="https://github.com/user-attachments/assets/c002c0be-03a1-401d-b6b5-18c488c9a9b8" />

  - 截图2：容器运行状态
   <img width="937" height="319" alt="8d81f59a204d417c6d9acd9befcf3dec" src="https://github.com/user-attachments/assets/6e08a4f5-cb89-4ccf-8231-0fce50db4621" />
   
  - 截图3：完整测试结果
    <img width="865" height="505" alt="image" src="https://github.com/user-attachments/assets/5c813f15-1b1b-4906-9f4f-00ffe54febc8" />
    <img width="865" height="401" alt="image" src="https://github.com/user-attachments/assets/ac15b4a5-e8ef-48cd-be59-332f0fc4b975" />
- **结果分析**：
  - 1.可验证性分析
    - 量化指标：镜像体积从1.11GB→65.5MB，有明确数字证明优化效果
    - 状态检查：所有容器状态为"Up"，端口映射正确显示
    - HTTP响应：每个端点返回正确的JSON格式数据，状态码均为200
  - 2.可复现性分析
    - 脚本化操作：所有步骤都有对应脚本（setup、build、run、test）
    - 环境明确：明确使用Ubuntu 24.04.3 LTS + Docker 28.5.1 + Python 3.9
    - 依赖锁定：requirements.txt固定版本，避免依赖冲突
  - 3.可解释性分析
    - 技术原理：多阶段构建减少镜像层数和文件数量
    - 安全设计：非root用户、只读挂载、健康检查等安全措施
    - 优化策略：Alpine基础镜像、清理缓存、合并指令等优化方法
  - 4.功能完整性验证
    <img width="894" height="488" alt="ed3949be8c3e30dcfd560d91f709c2b9" src="https://github.com/user-attachments/assets/8dd3d632-fab3-46db-8877-dbd838173d68" />
---

### 8. 运维与排错
- **问题 1**
  - 现象：输出无base镜像
  - 定位过程（命令/日志/对照项）：
    <img width="864" height="293" alt="image" src="https://github.com/user-attachments/assets/9cada64c-432f-4006-86f8-ece0d6b84a03" />
    <img width="865" height="171" alt="image" src="https://github.com/user-attachments/assets/429f2e3a-234f-499c-9d0c-8b12e20d183f" />
    <img width="865" height="549" alt="image" src="https://github.com/user-attachments/assets/19bcfd31-74f6-4818-9e60-57b77b5362c8" />
  - 根因：先确认 base 镜像确实存在，执行以下命令，就能看到 cloud-final-demo:base 镜像：
    <img width="864" height="77" alt="image" src="https://github.com/user-attachments/assets/48aa1801-d67a-476f-981f-53a62a6c6c14" />
    base 镜像未被任何 Pod / 后续构建阶段引用：多阶段构建中，base 镜像是 “临时构建镜像”—— 后续构建 1.0.0 镜像时，只复用了 builder 阶段的文件，并未引用 base 镜像；如配置了k8s环境，K8s kubelet 后台 GC 清理了无引用的 base 镜像；
  - 解决方法：如图所示
    -      vim build.sh 
       <img width="865" height="142" alt="image" src="https://github.com/user-attachments/assets/e1dfa307-efc3-4e48-abe9-dd8884dfab22" />
  - 复盘与预防：让base镜像保持 “被引用” 状态，如创建 “占位容器”。
 
- **问题 2**
  - 现象：健康检查失败
  - 定位过程（命令/日志/对照项）：
    <img width="864" height="303" alt="image" src="https://github.com/user-attachments/assets/3b045a30-1a78-42bf-bc17-e85f25711c8f" />
  - 根因：容器退出码 1 + 健康检查失败的根本原因：容器内的 Python 环境中没有安装 Flask（即使 Dockerfile 写了安装命令，也大概率是安装失败 / 未生效）。
  - 解决方法：第一步：先看容器是否真的在运行（排除启动即退出）
     - 执行以下命令，查看容器状态：
     - <img width="864" height="194" alt="image" src="https://github.com/user-attachments/assets/3b1be84f-a328-49f6-896a-13b6198debc8" />
     - 容器启动后立即退出（Exited (1)），退出码 1 表示应用执行时抛出了未捕获的错误（但日志为空，是因为没捕获到错误出）。
     - 查看demo1的错误日志（退出码1的核心原因）
     -        sudo docker logs cloud-final-demo1
     - <img width="865" height="116" alt="image" src="https://github.com/user-attachments/assets/3361e8e7-732c-4221-b840-45e12a244e6d" />
     - 确保 requirements.txt 正确创建：
     - <img width="865" height="226" alt="image" src="https://github.com/user-attachments/assets/0833c30a-6196-4866-888a-a4bc167a3afd" />
     - 最后检查代码，发现
     - 漏洞 1：多阶段构建的依赖复制路径不匹配。builder 阶段用 pip install --user 安装依赖，包会被放在 /root/.local（root 用户的用户目录）；runtime 阶段切换到了 appuser 非 root 用户，此时 PATH=/root/.local/bin 对 appuser 无效 —— 因为普通用户无权访问 root 的 .local 目录。
     - 漏洞2：启动命令的 Python 路径 + 参数缺失。runtime 阶段用的是 python:3.9-alpine 镜像，默认可能没有 python 软链接，只有 python3，启动命令 CMD ["python", "app/app.py"] 没加 --host=0.0.0.0，即使 Flask 安装成功，也只能监听容器内的 127.0.0.1，外部访问不到。
     -         vim Dockerfile
     - 修复：在 runtime 阶段把依赖复制到 appuser 的用户目录，再配置 PATH：
     - <img width="864" height="312" alt="image" src="https://github.com/user-attachments/assets/06aec246-a60a-4cdb-bb51-f4e658d06714" />
     - 修复：修改启动命令为 python3，并添加监听参数：
     - <img width="864" height="99" alt="image" src="https://github.com/user-attachments/assets/d94a6c2d-850c-45cd-853f-a98259737cf3" />
     - 重建镜像（清空缓存）:
     - <img width="865" height="381" alt="image" src="https://github.com/user-attachments/assets/49dcf583-454b-4005-a8df-2fb195096b32" />
     -        ./run.sh
     - <img width="805" height="243" alt="image" src="https://github.com/user-attachments/assets/6a85ab4c-c7ad-4771-8bb4-f1848a564679" />
 
- **问题 3**
  - 现象：
  - 定位过程（命令/日志/对照项）：
  - 根因：
  - 解决方法：
  - 复盘与预防：

---

### 9. 安全与合规说明

- 使用非root用户运行容器
- 敏感信息通过环境变量传递
- 配置最小权限原则
---

### 10. 小组分工与贡献说明

| 模块/任务 | 负责人 | 贡献说明（commit/截图/文档链接） |
|---|---|---|
| 项目实现 | 潘丽娜 | 项目代码 |
| 实验报告 | 李梦君 | 实验报告.md |
| PPT+仓库提交 | 潘婉钰 | 答辩PPT |
| 答辩 | 王露 | 答辩 |

---

### 11. 总结与展望

**本次实验学到的 3 点（对应课程内容）**
- 1、 Docker容器化技术实践（对应课程模块：容器技术）
- 2、 环境一致性保障（对应课程模块：云环境部署）
- 3、 微服务架构基础（对应课程模块：微服务）

**当前不足**
- 1、缺少监控告警：只能通过健康检查了解基本状态，缺乏性能指标监控
- 2、无滚动更新：更新应用需要停止旧容器，无法实现零停机部署
- 3、配置管理简单：环境变量方式适合简单配置，复杂配置需改进
- 4、启动时间较长：首次启动需要下载基础镜像，未使用本地镜像仓库
- 5、密钥管理简单：敏感信息直接写在环境变量中，未使用Secrets管理
- 6、测试覆盖率有限：只有基础功能测试，缺乏性能测试和压力测试
  
**未来改进**
- 1、数据库集成：添加PostgreSQL容器，数据持久化，完整应用栈演示
- 2、消息队列：集成RabbitMQ或Redis，异步处理演示
- 3、启动加速：构建本地镜像仓库、使用镜像缓存，启动时间<5s
- 4、健康检查增强：添加就绪检查和存活检查，更精确的状态监控
- 5、密钥管理：使用Docker Secrets或HashiCorp Vault，敏感信息加密存储
- 6、日志收集：ELK Stack (Elasticsearch, Logstash, Kibana)，集中日志分析

---

### 12. 附录

#### 12.1 资源清单

- 镜像/ISO/容器镜像来源：
  - Docker镜像：python:3.9-slim、python:3.9-alpine、python:3.9————Docker Hub官方Python镜像
  - 验证镜像	：hello-world————Docker Hub官方镜像
  - 应用镜像：cloud-final-demo:1.0.0————本地构建 (由Dockerfile生成)
  - 应用镜像	：cloud-final-demo:base————本地构建 (由Dockerfile.base生成)
- 参考资料（不少于 3 条，注明标题与来源）：
  - Docker官方文档 - Dockerfile最佳实践————https://docs.docker.com/build/building/best-practices/
  - Flask官方文档 - 应用工厂模式与配置————https://flask.palletsprojects.com/en/3.0.x/
  - GitHub - docker-library/python Issues————https://github.com/docker-library/python/issues

#### 12.2 一键复现
-     git clone <repo>
-     cd ~/cloud-final-project
-     ./start-all.sh

